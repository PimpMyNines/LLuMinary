

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lluminary.models.base &mdash; LLuMinary 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            LLuMinary
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../providers.html">Provider Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">LLuMinary</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">lluminary.models.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lluminary.models.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base class for LLM providers.</span>
<span class="sd">All provider-specific implementations should inherit from this class.</span>

<span class="sd">This base class provides common functionality, type definitions, and standard</span>
<span class="sd">error handling patterns that all provider implementations should follow.</span>
<span class="sd">It defines the interface and core behaviors expected from any provider.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LLMAuthenticationError</span><span class="p">,</span>
    <span class="n">LLMConfigurationError</span><span class="p">,</span>
    <span class="n">LLMContentError</span><span class="p">,</span>
    <span class="n">LLMError</span><span class="p">,</span>
    <span class="n">LLMFormatError</span><span class="p">,</span>
    <span class="n">LLMMistake</span><span class="p">,</span>
    <span class="n">LLMProviderError</span><span class="p">,</span>
    <span class="n">LLMRateLimitError</span><span class="p">,</span>
    <span class="n">LLMServiceUnavailableError</span><span class="p">,</span>
    <span class="n">LLMThinkingError</span><span class="p">,</span>
    <span class="n">LLMToolError</span><span class="p">,</span>
    <span class="n">LLMValidationError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.classification.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClassificationConfig</span>


<div class="viewcode-block" id="LLM">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LLM</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for LLM provider implementations.</span>

<span class="sd">    All provider implementations must inherit from this class and implement</span>
<span class="sd">    its abstract methods. This class defines the standard interface that all</span>
<span class="sd">    LLM providers must conform to, ensuring consistent behavior across different</span>
<span class="sd">    implementations.</span>

<span class="sd">    Class Variables:</span>
<span class="sd">        CONTEXT_WINDOW: Maximum token limits per model</span>
<span class="sd">        COST_PER_MODEL: Cost per token per model</span>
<span class="sd">        SUPPORTED_MODELS: List of supported model identifiers</span>
<span class="sd">        THINKING_MODELS: Models supporting thinking/reasoning</span>
<span class="sd">        EMBEDDING_MODELS: Models supporting embedding generation</span>
<span class="sd">        RERANKING_MODELS: Models supporting document reranking</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONTEXT_WINDOW</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">COST_PER_MODEL</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">SUPPORTED_MODELS</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">THINKING_MODELS</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">EMBEDDING_MODELS</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Models that support embeddings</span>
    <span class="n">RERANKING_MODELS</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Models that support reranking</span>

<div class="viewcode-block" id="LLM.generate">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">retry_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">result_processing_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thinking_budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a response with retry logic and error handling.</span>

<span class="sd">        This is the main entry point for generation that handles:</span>
<span class="sd">        1. Parameter validation</span>
<span class="sd">        2. Retry logic for recoverable errors</span>
<span class="sd">        3. Error handling and mapping to standard exceptions</span>
<span class="sd">        4. Usage statistics tracking</span>
<span class="sd">        5. Response processing and validation</span>

<span class="sd">        Args:</span>
<span class="sd">            event_id: Unique identifier for this generation</span>
<span class="sd">            system_prompt: Instructions for the model</span>
<span class="sd">            messages: List of messages to process</span>
<span class="sd">            max_tokens: Maximum tokens to generate</span>
<span class="sd">            temp: Temperature for generation</span>
<span class="sd">            tools: List of tools/functions to use</span>
<span class="sd">            retry_limit: Maximum number of retries</span>
<span class="sd">            result_processing_function: Function to process the result</span>
<span class="sd">            thinking_budget: Number of tokens for thinking (if supported)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple containing:</span>
<span class="sd">            - Generated response text</span>
<span class="sd">            - Usage statistics</span>
<span class="sd">            - Updated messages including the response</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If parameters are invalid</span>
<span class="sd">            LLMMistake: If generation fails after all retries</span>
<span class="sd">            LLMProviderError: For provider-specific errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Generate a unique event ID if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event_id</span><span class="p">:</span>
            <span class="n">event_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Validate all parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Validate basic parameters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;messages must be a list&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;messages list cannot be empty&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;At least one message is required for generation&quot;</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="c1"># Validate system prompt</span>
            <span class="k">if</span> <span class="n">system_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;system_prompt must be a string or None&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="c1"># Validate max_tokens</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_max_tokens</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">)</span>

            <span class="c1"># Validate temperature</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_temperature</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

            <span class="c1"># Validate tools if provided</span>
            <span class="k">if</span> <span class="n">tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

            <span class="c1"># Validate thinking budget if provided</span>
            <span class="k">if</span> <span class="n">thinking_budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_thinking_budget</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> does not support thinking budget&quot;</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thinking_budget</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">thinking_budget</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                        <span class="s2">&quot;thinking_budget must be a positive integer&quot;</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;provided&quot;</span><span class="p">:</span> <span class="n">thinking_budget</span><span class="p">,</span>
                            <span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">thinking_budget</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="n">LLMValidationError</span><span class="p">:</span>
            <span class="c1"># Re-raise validation errors without retry</span>
            <span class="k">raise</span>

        <span class="c1"># Initialize variables for retry logic</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">raw_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">working_messages</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Initialize cumulative usage stats</span>
        <span class="n">cumulative_usage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;read_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;write_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;total_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;read_cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;write_cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;total_cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;image_cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="n">event_id</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="n">provider_name</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Generation with retry loop</span>
        <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">retry_limit</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Generate raw response</span>
                <span class="n">raw_response</span><span class="p">,</span> <span class="n">usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_generate</span><span class="p">(</span>
                    <span class="n">event_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s2">_attempt_</span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                    <span class="n">messages</span><span class="o">=</span><span class="n">working_messages</span><span class="p">,</span>
                    <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
                    <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
                    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                    <span class="n">thinking_budget</span><span class="o">=</span><span class="n">thinking_budget</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Update usage statistics</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cumulative_usage</span><span class="p">:</span>
                        <span class="n">cumulative_usage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">usage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="c1"># Process and validate response</span>
                <span class="k">if</span> <span class="n">result_processing_function</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">result_processing_function</span><span class="p">(</span><span class="n">raw_response</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">proc_error</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">LLMFormatError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Response processing failed: </span><span class="si">{</span><span class="n">proc_error</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                            <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                                <span class="s2">&quot;raw_response&quot;</span><span class="p">:</span> <span class="n">raw_response</span><span class="p">,</span>
                                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">proc_error</span><span class="p">),</span>
                                <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">proc_error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">raw_response</span>

                <span class="c1"># Check for empty response</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">LLMContentError</span><span class="p">(</span>
                        <span class="s2">&quot;Model returned empty response with no tool calls&quot;</span><span class="p">,</span>
                        <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;usage&quot;</span><span class="p">:</span> <span class="n">usage</span><span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># Prepare response message</span>
                <span class="n">ai_message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ai&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>

                <span class="c1"># Add tool use data if present</span>
                <span class="k">if</span> <span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">):</span>
                    <span class="n">ai_message</span><span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">]</span>

                <span class="c1"># Add thinking data if present</span>
                <span class="k">if</span> <span class="n">usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thinking&quot;</span><span class="p">):</span>
                    <span class="n">ai_message</span><span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">]</span>

                <span class="c1"># Create updated messages list</span>
                <span class="n">updated_messages</span> <span class="o">=</span> <span class="n">working_messages</span> <span class="o">+</span> <span class="p">[</span><span class="n">ai_message</span><span class="p">]</span>

                <span class="c1"># Update final usage stats</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;provider&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">provider_name</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attempts</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;successful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">cumulative_usage</span><span class="p">,</span> <span class="n">updated_messages</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">LLMRateLimitError</span><span class="p">,</span> <span class="n">LLMServiceUnavailableError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># These errors are always retried</span>
                <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attempts</span>

                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="n">retry_limit</span><span class="p">:</span>
                    <span class="c1"># We&#39;ve exhausted retries for rate limit/service errors</span>
                    <span class="k">raise</span> <span class="n">LLMProviderError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Provider error persisted after </span><span class="si">{</span><span class="n">retry_limit</span><span class="si">}</span><span class="s2"> retries: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;retry_limit&quot;</span><span class="p">:</span> <span class="n">retry_limit</span><span class="p">,</span>
                            <span class="s2">&quot;last_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># Calculate retry delay with exponential backoff</span>
                <span class="n">retry_after</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;retry_after&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retry_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wait_time</span> <span class="o">=</span> <span class="n">retry_after</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wait_time</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">attempts</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>  <span class="c1"># 1, 2, 4, 8 seconds...</span>

                <span class="c1"># Add jitter to avoid thundering herd</span>
                <span class="n">wait_time</span> <span class="o">*=</span> <span class="mf">0.75</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>  <span class="c1"># 75-125% of wait_time</span>

                <span class="c1"># Wait before retrying</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">LLMMistake</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Potentially recoverable errors</span>
                <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attempts</span>

                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="n">retry_limit</span><span class="p">:</span>
                    <span class="c1"># We&#39;ve exhausted retries for recoverable errors</span>
                    <span class="k">raise</span> <span class="n">LLMMistake</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to get valid response after </span><span class="si">{</span><span class="n">retry_limit</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">,</span>
                        <span class="n">error_type</span><span class="o">=</span><span class="s2">&quot;retry_limit_exceeded&quot;</span><span class="p">,</span>
                        <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;retry_limit&quot;</span><span class="p">:</span> <span class="n">retry_limit</span><span class="p">,</span>
                            <span class="s2">&quot;last_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># Add failed response to working messages</span>
                <span class="n">working_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error in previous response: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">. Please try again.&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span>
                <span class="n">LLMAuthenticationError</span><span class="p">,</span>
                <span class="n">LLMValidationError</span><span class="p">,</span>
                <span class="n">LLMConfigurationError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Non-recoverable errors - re-raise immediately</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;successful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">raise</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Unexpected errors - map to appropriate type and re-raise</span>
                <span class="n">mapped_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_provider_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mapped_error</span><span class="p">)</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">mapped_error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;successful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">raise</span> <span class="n">mapped_error</span>

        <span class="c1"># This should never be reached due to the retry loop</span>
        <span class="k">raise</span> <span class="n">LLMProviderError</span><span class="p">(</span>
            <span class="s2">&quot;Unexpected end of generation method&quot;</span><span class="p">,</span>
            <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="n">event_id</span><span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LLM.__init__">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the LLM provider with the specified model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name: Name of the model to use</span>
<span class="sd">            **kwargs: Additional provider-specific configuration</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If the model is not supported or configuration is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_model_name</span>

        <span class="c1"># Validate model name</span>
        <span class="n">validate_model_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_supported_models</span><span class="p">())</span>

        <span class="c1"># Set model name and configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="c1"># Validate provider configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_provider_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Initialize capability detection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_capabilities</span><span class="p">()</span>

        <span class="c1"># Authenticate with the provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">()</span></div>


    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_provider_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate provider-specific configuration.</span>
<span class="sd">        Override this method in provider implementations.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Provider configuration</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If configuration is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_max_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">context_window</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate max_tokens parameter against model&#39;s context window.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_tokens: Maximum tokens to generate</span>
<span class="sd">            context_window: Optional context window override (defaults to model&#39;s window)</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If max_tokens is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;max_tokens must be an integer&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;provided&quot;</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
                    <span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">max_tokens</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;max_tokens must be greater than 0&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided&quot;</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Get model&#39;s context window if not provided</span>
        <span class="k">if</span> <span class="n">context_window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_window</span><span class="p">()</span>

        <span class="c1"># Check if max_tokens exceeds context window</span>
        <span class="k">if</span> <span class="n">max_tokens</span> <span class="o">&gt;</span> <span class="n">context_window</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;max_tokens (</span><span class="si">{</span><span class="n">max_tokens</span><span class="si">}</span><span class="s2">) exceeds model context window (</span><span class="si">{</span><span class="n">context_window</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
                    <span class="s2">&quot;context_window&quot;</span><span class="p">:</span> <span class="n">context_window</span><span class="p">,</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate temperature parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            temp: Temperature for generation</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If temperature is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Temperature must be a number&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided&quot;</span><span class="p">:</span> <span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Most providers use temperature in range [0.0, 2.0]</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Temperature should be between 0.0 and 2.0&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided&quot;</span><span class="p">:</span> <span class="n">temp</span><span class="p">}</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate tools parameter for function calling.</span>

<span class="sd">        Args:</span>
<span class="sd">            tools: List of tool/function definitions</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If tools format is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_tools</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;tools must be a list&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Use common validator</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid tools format: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="p">)</span>

        <span class="c1"># Check for required capabilities</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_tool_calling</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_functions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> does not support function/tool calling&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">},</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize capability detection for the selected model.</span>
<span class="sd">        This sets up the has_capability attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.capabilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">Capability</span><span class="p">,</span> <span class="n">CapabilityRegistry</span>

        <span class="c1"># Get class name for provider detection</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Set up capability detection attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider_capabilities</span> <span class="o">=</span> <span class="n">CapabilityRegistry</span><span class="o">.</span><span class="n">get_provider_capabilities</span><span class="p">(</span>
            <span class="n">provider_name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span> <span class="o">=</span> <span class="n">CapabilityRegistry</span><span class="o">.</span><span class="n">get_model_capabilities</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span>
        <span class="p">)</span>

        <span class="c1"># Initialize capability attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_text_generation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Capability</span><span class="o">.</span><span class="n">TEXT_GENERATION</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_text_embeddings</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Capability</span><span class="o">.</span><span class="n">TEXT_EMBEDDINGS</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_image_input</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">IMAGE_INPUT</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_image_generation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Capability</span><span class="o">.</span><span class="n">IMAGE_GENERATION</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_streaming</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">STREAMING</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_functions</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">FUNCTIONS</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_reranking</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">RERANKING</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_thinking_budget</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Capability</span><span class="o">.</span><span class="n">THINKING_BUDGET</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_json_mode</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">JSON_MODE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_tool_calling</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">TOOL_CALLING</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_vision</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="n">VISION</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_map_provider_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LLMError</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map provider-specific errors to standardized LLM error types.</span>

<span class="sd">        This base implementation provides simple string matching to categorize</span>
<span class="sd">        common error types. Provider implementations should override this method</span>
<span class="sd">        with provider-specific error mapping logic.</span>

<span class="sd">        Args:</span>
<span class="sd">            error: The original exception from the provider</span>

<span class="sd">        Returns:</span>
<span class="sd">            LLMError: Appropriate mapped exception with context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Check for common error patterns</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;auth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;credential&quot;</span><span class="p">,</span>
                <span class="s2">&quot;permission&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unauthorized&quot;</span><span class="p">,</span>
                <span class="s2">&quot;access denied&quot;</span><span class="p">,</span>
                <span class="s2">&quot;token&quot;</span><span class="p">,</span>
                <span class="s2">&quot;signature&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMAuthenticationError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> authentication failed: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;rate limit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;quota&quot;</span><span class="p">,</span>
                <span class="s2">&quot;throttl&quot;</span><span class="p">,</span>
                <span class="s2">&quot;too many requests&quot;</span><span class="p">,</span>
                <span class="s2">&quot;requests per minute&quot;</span><span class="p">,</span>
                <span class="s2">&quot;capacity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;overloaded&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMRateLimitError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> rate limit exceeded: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">retry_after</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>  <span class="c1"># Default retry delay</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;unavailable&quot;</span><span class="p">,</span>
                <span class="s2">&quot;down&quot;</span><span class="p">,</span>
                <span class="s2">&quot;outage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maintenance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;500&quot;</span><span class="p">,</span>
                <span class="s2">&quot;502&quot;</span><span class="p">,</span>
                <span class="s2">&quot;503&quot;</span><span class="p">,</span>
                <span class="s2">&quot;504&quot;</span><span class="p">,</span>
                <span class="s2">&quot;server error&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMServiceUnavailableError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> service unavailable: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;content&quot;</span><span class="p">,</span>
                <span class="s2">&quot;moderation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;policy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;violation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;harmful&quot;</span><span class="p">,</span>
                <span class="s2">&quot;inappropriate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unsafe&quot;</span><span class="p">,</span>
                <span class="s2">&quot;blocked&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMContentError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> content policy violation: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;format&quot;</span><span class="p">,</span>
                <span class="s2">&quot;json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xml&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parse&quot;</span><span class="p">,</span>
                <span class="s2">&quot;serialization&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deserialization&quot;</span><span class="p">,</span>
                <span class="s2">&quot;invalid format&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMFormatError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> format error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="s2">&quot;argument&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMToolError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> tool error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">,</span> <span class="s2">&quot;thought&quot;</span><span class="p">,</span> <span class="s2">&quot;budget&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMThinkingError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> thinking error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">term</span> <span class="ow">in</span> <span class="n">error_message</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;invalid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
                <span class="s2">&quot;setting&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;not supported&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unsupported&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deprecated&quot;</span><span class="p">,</span>
                <span class="s2">&quot;required&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">LLMConfigurationError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> configuration error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Default case</span>
        <span class="k">return</span> <span class="n">LLMProviderError</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_with_retry</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">initial_backoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">backoff_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">retryable_errors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call a function with exponential backoff retry logic.</span>

<span class="sd">        This method provides standardized retry logic for API calls that may</span>
<span class="sd">        experience transient failures. It implements exponential backoff with</span>
<span class="sd">        jitter to avoid overwhelming services during recovery.</span>

<span class="sd">        Args:</span>
<span class="sd">            func: The function to call</span>
<span class="sd">            *args: Positional arguments to pass to the function</span>
<span class="sd">            max_retries: Maximum number of retry attempts</span>
<span class="sd">            initial_backoff: Initial backoff time in seconds</span>
<span class="sd">            backoff_factor: Multiplier for backoff on each retry</span>
<span class="sd">            retryable_errors: List of exception types that should trigger a retry</span>
<span class="sd">            **kwargs: Keyword arguments to pass to the function</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The return value from the function</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMError: The mapped exception after all retries are exhausted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">retryable_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retryable_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">LLMRateLimitError</span><span class="p">,</span> <span class="n">LLMServiceUnavailableError</span><span class="p">]</span>

        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">backoff_time</span> <span class="o">=</span> <span class="n">initial_backoff</span>
        <span class="n">last_exception</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">while</span> <span class="n">retry_count</span> <span class="o">&lt;=</span> <span class="n">max_retries</span><span class="p">:</span>  <span class="c1"># &lt;= because first attempt is not a retry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">except</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">retryable_errors</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>

                <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="c1"># We&#39;ve exhausted retries, re-raise the last error</span>
                    <span class="k">raise</span>

                <span class="c1"># Get retry-after time if available (for rate limits)</span>
                <span class="n">retry_after</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">LLMRateLimitError</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;retry_after&quot;</span><span class="p">):</span>
                    <span class="n">retry_after</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">retry_after</span>

                <span class="c1"># Use retry-after if available, otherwise use exponential backoff</span>
                <span class="n">wait_time</span> <span class="o">=</span> <span class="n">retry_after</span> <span class="k">if</span> <span class="n">retry_after</span> <span class="k">else</span> <span class="n">backoff_time</span>

                <span class="c1"># Add jitter to avoid thundering herd problem</span>
                <span class="n">jitter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wait_time</span><span class="p">)</span>
                <span class="n">wait_time</span> <span class="o">+=</span> <span class="n">jitter</span>

                <span class="c1"># Log retry attempt (if provider has a logger)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                    <span class="n">provider_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Retrying </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> after error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">wait_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Wait before retry</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>

                <span class="c1"># Increase backoff for next retry</span>
                <span class="n">backoff_time</span> <span class="o">*=</span> <span class="n">backoff_factor</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># For other exceptions, map to appropriate error type and raise</span>
                <span class="n">mapped_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_provider_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">mapped_error</span>

        <span class="c1"># Should never get here, but just in case</span>
        <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">last_exception</span>

        <span class="c1"># Generic fallback error if we somehow get here</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LLMProviderError</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries&quot;</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="n">provider_name</span>
        <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_messages_for_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert standard message format into model-specific format.</span>

<span class="sd">        Standard format:</span>
<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;message_type&quot;: &quot;human&quot;,</span>
<span class="sd">                &quot;message&quot;: &quot;Hello how are you today?&quot;,</span>
<span class="sd">                &quot;image_paths&quot;: [&quot;path/to/image.jpg&quot;],</span>
<span class="sd">                &quot;image_urls&quot;: [&quot;www.url.com/image.jpg&quot;]</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                &quot;message_type&quot;: &quot;ai&quot;,</span>
<span class="sd">                &quot;message&quot;: &quot;I am doing great, how are you?&quot;</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>

<span class="sd">        Args:</span>
<span class="sd">            messages (List[Dict[str, Any]]): List of messages in standard format</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: Messages formatted for specific model API</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="LLM.auth">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.auth">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate with the LLM provider.</span>
<span class="sd">        Should be called during initialization.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If authentication fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_raw_generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thinking_budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a response from the LLM without error correction.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_id (str): Unique identifier for this generation event</span>
<span class="sd">            system_prompt (str): System-level instructions for the model</span>
<span class="sd">            messages (List[Dict[str, Any]]): List of messages in the standard format</span>
<span class="sd">            max_tokens (int, optional): Maximum number of tokens to generate. Defaults to 1000.</span>
<span class="sd">            temp (float, optional): Temperature for generation. Defaults to 0.0.</span>
<span class="sd">            top_k (int, optional): Top K tokens to consider. Defaults to 200.</span>
<span class="sd">            tools (List[Dict[str, Any]], optional): List of tools to use. Defaults to None.</span>
<span class="sd">            thinking_budget (int, optional): Number of tokens allowed for thinking. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, Dict[str, Any]]: Tuple containing:</span>
<span class="sd">                - str: The generated response</span>
<span class="sd">                - Dict[str, Any]: Usage statistics including:</span>
<span class="sd">                    - read_tokens: Number of input tokens</span>
<span class="sd">                    - write_tokens: Number of output tokens</span>
<span class="sd">                    - images: Number of images processed</span>
<span class="sd">                    - total_tokens: Total tokens used</span>
<span class="sd">                    - read_cost: Cost of input tokens</span>
<span class="sd">                    - write_cost: Cost of output tokens</span>
<span class="sd">                    - image_cost: Cost of image processing</span>
<span class="sd">                    - total_cost: Total cost of the request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># Include remaining methods from original file</span>
<div class="viewcode-block" id="LLM.rerank">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.rerank">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">top_n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_scores</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rerank a list of documents based on their relevance to a query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): The search query to rank documents against</span>
<span class="sd">            documents (List[str]): List of document texts to rerank</span>
<span class="sd">            top_n (int, optional): Number of top documents to return. If None, returns all documents</span>
<span class="sd">            return_scores (bool): Whether to include relevance scores in the output</span>
<span class="sd">            **kwargs: Additional provider-specific parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: Dictionary containing:</span>
<span class="sd">                - &#39;ranked_documents&#39; (List[str]): List of reranked document texts</span>
<span class="sd">                - &#39;indices&#39; (List[int]): Original indices of the reranked documents</span>
<span class="sd">                - &#39;scores&#39; (List[float], optional): Relevance scores if return_scores=True</span>
<span class="sd">                - &#39;usage&#39; (Dict): Token usage and cost information</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If input parameters are invalid</span>
<span class="sd">            NotImplementedError: If the model doesn&#39;t support reranking</span>
<span class="sd">            LLMProviderError: For provider-specific errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMValidationError</span>

        <span class="c1"># Validate that model has reranking capability</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_reranking</span><span class="p">:</span>
            <span class="n">available_models</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">model</span>
                <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_supported_models</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RERANKING_MODELS</span>
            <span class="p">]</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> does not support document reranking. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available reranking models: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available_models</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate input parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Query must be a string&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Query cannot be empty&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Empty query would result in meaningless rankings&quot;</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Documents must be a list&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">documents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Documents list cannot be empty&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;At least one document is required for reranking&quot;</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Document at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must be a string, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">top_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top_n</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;top_n must be an integer or None&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">top_n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;top_n must be positive&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_value&quot;</span><span class="p">:</span> <span class="n">top_n</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">top_n</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;top_n (</span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s2">) exceeds the number of documents (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;top_n&quot;</span><span class="p">:</span> <span class="n">top_n</span><span class="p">,</span> <span class="s2">&quot;document_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)},</span>
                <span class="p">)</span>

        <span class="c1"># This method must be implemented by the provider</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method must be implemented by the provider&quot;</span><span class="p">)</span>

        <span class="c1"># Unreachable code, but needed for type checking</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ranked_documents&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;usage&quot;</span><span class="p">:</span> <span class="p">{}}</span></div>


<div class="viewcode-block" id="LLM.stream_generate">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.stream_generate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stream_generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">functions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream a response from the LLM, yielding chunks as they become available.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_id (str): Unique identifier for this generation event</span>
<span class="sd">            system_prompt (str): System-level instructions for the model</span>
<span class="sd">            messages (List[Dict[str, Any]]): List of messages in the standard format</span>
<span class="sd">            max_tokens (int): Maximum number of tokens to generate</span>
<span class="sd">            temp (float): Temperature for generation</span>
<span class="sd">            functions (List[Callable]): List of functions the LLM can use</span>
<span class="sd">            callback (Callable): Optional callback function for each chunk</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[str, Dict[str, Any]]: Tuples of (text_chunk, partial_usage_data)</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the provider doesn&#39;t implement streaming</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Streaming is not implemented for provider </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_function_to_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a function to a tool&quot;&quot;&quot;</span>
        <span class="c1"># Get function name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Get function docstring</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">function</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Extract main description (first line or paragraph of docstring)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Get function signature</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

        <span class="c1"># Build input schema</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip *args, **kwargs, and self/cls parameters</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Add parameter to required list if it has no default value</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

            <span class="c1"># Determine parameter type</span>
            <span class="n">param_type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>  <span class="c1"># default type</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">!=</span> <span class="n">param</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">param_type</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">param_type</span> <span class="o">=</span> <span class="s2">&quot;integer&quot;</span>
                <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">param_type</span> <span class="o">=</span> <span class="s2">&quot;number&quot;</span>
                <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="n">param_type</span> <span class="o">=</span> <span class="s2">&quot;boolean&quot;</span>
                <span class="c1"># Add more type mappings as needed</span>

            <span class="c1"># Try to extract parameter description from docstring</span>
            <span class="n">param_desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>
                <span class="c1"># Look for Args section in docstring</span>
                <span class="n">args_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;Args:(.*?)(?:\n\n|\n[A-Z]|\Z)&quot;</span><span class="p">,</span> <span class="n">docstring</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">args_match</span><span class="p">:</span>
                    <span class="n">args_section</span> <span class="o">=</span> <span class="n">args_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Look for this parameter in the Args section</span>
                    <span class="n">param_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                        <span class="sa">rf</span><span class="s2">&quot;\s+</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">\s*(?:\(.*?\))?\s*:\s*(.*?)(?:\n\s+\w+\s*:|$)&quot;</span><span class="p">,</span>
                        <span class="n">args_section</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">param_match</span><span class="p">:</span>
                        <span class="n">param_desc</span> <span class="o">=</span> <span class="n">param_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Add parameter to properties</span>
            <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">param_type</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">param_desc</span>
                <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> for function </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Build the tool dictionary</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;input_schema&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span>
                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="n">required</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">tool</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_functions_to_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a list of functions to a list of tools&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_function_to_tool</span><span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">]</span>

        <span class="c1"># Second generate method - removed to avoid duplication</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a response with automatic error correction.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_id: Unique identifier for this generation event</span>
<span class="sd">            system_prompt: System-level instructions</span>
<span class="sd">            messages: List of messages in standard format</span>
<span class="sd">            max_tokens: Maximum tokens to generate</span>
<span class="sd">            temp: Temperature for generation</span>
<span class="sd">            result_processing_function: Function to validate and transform response</span>
<span class="sd">            retry_limit: Maximum number of attempts (including first try)</span>
<span class="sd">            functions: List of functions to use as tools</span>
<span class="sd">            thinking_budget: Number of tokens allowed for thinking</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Any, Dict[str, Any], List[Dict[str, Any]]]:</span>
<span class="sd">                - Processed response (type depends on processing function)</span>
<span class="sd">                - Usage statistics</span>
<span class="sd">                - Updated messages including the response</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If input parameters are invalid</span>
<span class="sd">            LLMMistake: If valid response not obtained within retry_limit</span>
<span class="sd">            LLMProviderError: For provider-specific errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMValidationError</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">validate_max_tokens</span><span class="p">,</span>
            <span class="n">validate_messages</span><span class="p">,</span>
            <span class="n">validate_temperature</span><span class="p">,</span>
            <span class="n">validate_tools</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Validate input parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">event_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;event_id must be a non-empty string&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;system_prompt must be a string&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="n">validate_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">validate_temperature</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">validate_max_tokens</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_window</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">retry_limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;retry_limit must be at least 1&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_value&quot;</span><span class="p">:</span> <span class="n">retry_limit</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Initialize tracking variables</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cumulative_usage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;read_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;write_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;total_tokens&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;read_cost&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;write_cost&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;image_cost&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;total_cost&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">raw_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Initialize working messages with a deep copy to avoid modifying original</span>
        <span class="n">working_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span>

        <span class="c1"># Handle tool conversion for different providers</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;functions must be a list&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="c1"># Different handling for Gemini vs. other models</span>
            <span class="k">if</span> <span class="s2">&quot;gemini&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">:</span>
                <span class="c1"># Cast to expected type for Gemini</span>
                <span class="n">tools</span> <span class="o">=</span> <span class="n">functions</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_functions_to_tools</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>
                <span class="n">validate_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="c1"># Validate thinking budget if model supports it and value is provided</span>
        <span class="k">if</span> <span class="n">thinking_budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_thinking_budget</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> does not support thinking budget&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thinking_budget</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">thinking_budget</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;thinking_budget must be a positive integer&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_value&quot;</span><span class="p">:</span> <span class="n">thinking_budget</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="c1"># Generation with retry loop</span>
        <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">retry_limit</span><span class="p">:</span>  <span class="c1"># Includes first attempt</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Generate raw response, with thinking budget if supported</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_thinking_budget</span> <span class="ow">and</span> <span class="n">thinking_budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">raw_response</span><span class="p">,</span> <span class="n">usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_generate</span><span class="p">(</span>
                        <span class="n">event_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s2">_attempt_</span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                        <span class="n">messages</span><span class="o">=</span><span class="n">working_messages</span><span class="p">,</span>
                        <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
                        <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                        <span class="n">thinking_budget</span><span class="o">=</span><span class="n">thinking_budget</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">raw_response</span><span class="p">,</span> <span class="n">usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_generate</span><span class="p">(</span>
                        <span class="n">event_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s2">_attempt_</span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                        <span class="n">messages</span><span class="o">=</span><span class="n">working_messages</span><span class="p">,</span>
                        <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
                        <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
                        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Update usage statistics</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cumulative_usage</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">:</span>
                        <span class="n">cumulative_usage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">usage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="c1"># Track special usage fields</span>
                <span class="k">if</span> <span class="s2">&quot;thinking&quot;</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">:</span>
                    <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">]</span>
                    <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;thinking_signature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;thinking_signature&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s2">&quot;tool_use&quot;</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">:</span>
                    <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">]</span>

                <span class="c1"># Process and validate response</span>
                <span class="k">if</span> <span class="n">result_processing_function</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">result_processing_function</span><span class="p">(</span><span class="n">raw_response</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">proc_error</span><span class="p">:</span>
                        <span class="c1"># Convert processing errors to LLMMistake for retry</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMFormatError</span>

                        <span class="k">raise</span> <span class="n">LLMFormatError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Response processing failed: </span><span class="si">{</span><span class="n">proc_error</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;raw_response&quot;</span><span class="p">:</span> <span class="n">raw_response</span><span class="p">},</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">raw_response</span>

                <span class="c1"># Prepare response message</span>
                <span class="n">ai_message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ai&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>

                <span class="c1"># Add tool use information if available</span>
                <span class="k">if</span> <span class="s2">&quot;tool_use&quot;</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">:</span>
                    <span class="n">ai_message</span><span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">]</span>

                <span class="c1"># Add thinking information if available</span>
                <span class="k">if</span> <span class="s2">&quot;thinking&quot;</span> <span class="ow">in</span> <span class="n">usage</span><span class="p">:</span>
                    <span class="n">ai_message</span><span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;thinking&quot;</span><span class="p">:</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;thinking&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;thinking_signature&quot;</span><span class="p">:</span> <span class="n">usage</span><span class="p">[</span><span class="s2">&quot;thinking_signature&quot;</span><span class="p">],</span>
                    <span class="p">}</span>

                <span class="c1"># Create updated messages list</span>
                <span class="n">updated_messages</span> <span class="o">=</span> <span class="n">working_messages</span> <span class="o">+</span> <span class="p">[</span><span class="n">ai_message</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">raw_response</span><span class="p">,</span> <span class="n">cumulative_usage</span><span class="p">,</span> <span class="n">updated_messages</span>

            <span class="k">except</span> <span class="n">LLMMistake</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cumulative_usage</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attempts</span>

                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="n">retry_limit</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LLMMistake</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to get valid response after </span><span class="si">{</span><span class="n">retry_limit</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Last error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">error_type</span><span class="o">=</span><span class="s2">&quot;retry_limit_exceeded&quot;</span><span class="p">,</span>
                        <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;retry_limit&quot;</span><span class="p">:</span> <span class="n">retry_limit</span><span class="p">,</span>
                            <span class="s2">&quot;last_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                            <span class="s2">&quot;last_response&quot;</span><span class="p">:</span> <span class="n">raw_response</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># Add failed response and error to working messages</span>
                <span class="n">working_messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ai&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">raw_response</span><span class="p">,</span>
                            <span class="s2">&quot;image_paths&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;image_urls&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error in previous response: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">. Please try again.&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;image_paths&quot;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s2">&quot;image_urls&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="p">},</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># For non-LLMMistake exceptions, propagate them immediately</span>
                <span class="c1"># but wrap in a standardized exception type</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMProviderError</span>

                <span class="k">raise</span> <span class="n">LLMProviderError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Provider error during generation: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;original_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="p">)</span>

<div class="viewcode-block" id="LLM.get_context_window">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.get_context_window">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_window</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the context window size for the current model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Maximum number of tokens the model can process</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If context window information is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_WINDOW</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Context window information not available for model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="LLM.get_model_costs">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.get_model_costs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the cost information for the current model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Union[float, None]]: Dictionary containing read_token, write_token, and image_cost</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If cost information is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">COST_PER_MODEL</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cost information not available for model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="LLM.estimate_tokens">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.estimate_tokens">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the number of tokens in a text string.</span>
<span class="sd">        This is a rough estimate based on words/characters.</span>
<span class="sd">        For accurate counts, implement provider-specific token counting.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): Text to estimate tokens for</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Estimated number of tokens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rough estimate: ~4 characters per token</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="LLM.check_context_fit">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.check_context_fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_context_fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_response_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a prompt will fit in the model&#39;s context window.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The input prompt</span>
<span class="sd">            max_response_tokens (Optional[int]): Expected maximum response length in tokens</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[bool, str]: (True if fits, explanation message)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context_window</span><span class="p">()</span>
        <span class="n">estimated_prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_tokens</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">max_response</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_response_tokens</span> <span class="ow">or</span> <span class="n">context_window</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="p">)</span>  <span class="c1"># Default to 1/4 of context window</span>

        <span class="n">total_tokens</span> <span class="o">=</span> <span class="n">estimated_prompt_tokens</span> <span class="o">+</span> <span class="n">max_response</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="n">total_tokens</span> <span class="o">&lt;=</span> <span class="n">context_window</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Estimated usage: </span><span class="si">{</span><span class="n">estimated_prompt_tokens</span><span class="si">}</span><span class="s2"> prompt tokens + </span><span class="si">{</span><span class="n">max_response</span><span class="si">}</span><span class="s2"> max response tokens = </span><span class="si">{</span><span class="n">total_tokens</span><span class="si">}</span><span class="s2"> total</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Context window: </span><span class="si">{</span><span class="n">context_window</span><span class="si">}</span><span class="s2"> tokens</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="s1">&#39;Fits within context window&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">fits</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Exceeds context window&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fits</span><span class="p">,</span> <span class="n">message</span></div>


<div class="viewcode-block" id="LLM.estimate_cost">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.estimate_cost">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_cost</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">expected_response_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">images</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_images</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the cost for a generation based on input and expected output.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The input prompt</span>
<span class="sd">            expected_response_tokens (Optional[int]): Expected response length in tokens</span>
<span class="sd">            images (Optional[List[Tuple[int, int, str]]]): List of (width, height, detail) for each image</span>
<span class="sd">            num_images (Optional[int]): Simple count of images (used if images parameter not provided)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float, Dict[str, float]]: (Total cost, Breakdown of costs)</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If cost calculation fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_costs</span><span class="p">()</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_tokens</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">response_tokens</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">expected_response_tokens</span> <span class="ow">or</span> <span class="n">prompt_tokens</span>
        <span class="p">)</span>  <span class="c1"># Default to same length as prompt</span>

        <span class="c1"># Calculate costs</span>
        <span class="n">read_token_cost</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s2">&quot;read_token&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">0.0</span>
        <span class="n">write_token_cost</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s2">&quot;write_token&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mf">0.0</span>
        <span class="n">prompt_cost</span> <span class="o">=</span> <span class="n">prompt_tokens</span> <span class="o">*</span> <span class="n">read_token_cost</span>
        <span class="n">response_cost</span> <span class="o">=</span> <span class="n">response_tokens</span> <span class="o">*</span> <span class="n">write_token_cost</span>

        <span class="c1"># Calculate image cost based on available information</span>
        <span class="n">image_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="k">if</span> <span class="n">images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">num_images</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">image_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;image_cost&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">image_count</span>

        <span class="n">cost_breakdown</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;prompt_cost&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">prompt_cost</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
            <span class="s2">&quot;response_cost&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">response_cost</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
            <span class="s2">&quot;image_cost&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">image_cost</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cost_breakdown</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_cost</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">cost_breakdown</span></div>


<div class="viewcode-block" id="LLM.supports_image_input">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.supports_image_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">supports_image_input</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current model supports image input.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the model supports image input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_costs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">costs</span><span class="p">[</span><span class="s2">&quot;image_cost&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="LLM.get_supported_models">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.get_supported_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_supported_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of model names supported by this provider.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: List of supported model names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_MODELS</span></div>


<div class="viewcode-block" id="LLM.validate_model">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.validate_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if a given model name is supported by this provider.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (str): Name of the model to validate</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if model is supported, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_MODELS</span></div>


<div class="viewcode-block" id="LLM.classify">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.classify">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">categories</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">examples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_options</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify input into predefined categories using the LLM.</span>

<span class="sd">        Args:</span>
<span class="sd">            messages: Standard message format list</span>
<span class="sd">            categories: Dict mapping category names to descriptions</span>
<span class="sd">            examples: Optional list of example classifications</span>
<span class="sd">            max_options: Maximum number of categories to select (default: 1)</span>
<span class="sd">            system_prompt: Optional override for system prompt</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[str], Dict[str, Any]]: Selected category names and usage stats</span>

<span class="sd">        Raises:</span>
<span class="sd">            LLMValidationError: If input parameters are invalid</span>
<span class="sd">            LLMMistake: If classification fails</span>
<span class="sd">            LLMProviderError: For provider-specific errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLMMistake</span><span class="p">,</span> <span class="n">LLMValidationError</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_categories</span><span class="p">,</span> <span class="n">validate_messages</span>

        <span class="c1"># Validate input parameters</span>
        <span class="n">validate_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">validate_categories</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>

        <span class="c1"># Validate examples if provided</span>
        <span class="k">if</span> <span class="n">examples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;Examples must be a list&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                <span class="p">)</span>

            <span class="n">required_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_input&quot;</span><span class="p">,</span> <span class="s2">&quot;doc_str&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Example at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must be a dictionary, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">example</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">example</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
                    <span class="p">)</span>

                <span class="n">missing_keys</span> <span class="o">=</span> <span class="n">required_keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Example at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is missing required keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                            <span class="s2">&quot;missing_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">),</span>
                            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="c1"># Validate selection is in categories</span>
                <span class="k">if</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Example at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> has invalid selection: &#39;</span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Valid categories are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                            <span class="s2">&quot;invalid_selection&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;selection&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;valid_categories&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

        <span class="c1"># Validate max_options</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_options</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;max_options must be an integer&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_options</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">max_options</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;max_options must be at least 1&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_value&quot;</span><span class="p">:</span> <span class="n">max_options</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">max_options</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;max_options (</span><span class="si">{</span><span class="n">max_options</span><span class="si">}</span><span class="s2">) exceeds the number of categories (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_options&quot;</span><span class="p">:</span> <span class="n">max_options</span><span class="p">,</span> <span class="s2">&quot;category_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">system_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LLMValidationError</span><span class="p">(</span>
                <span class="s2">&quot;system_prompt must be a string or None&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;provided_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Store categories for response parsing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">categories</span>

        <span class="c1"># Format the classification prompt</span>
        <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_classification_prompt</span><span class="p">(</span>
            <span class="n">categories</span><span class="o">=</span><span class="n">categories</span><span class="p">,</span> <span class="n">examples</span><span class="o">=</span><span class="n">examples</span><span class="p">,</span> <span class="n">max_options</span><span class="o">=</span><span class="n">max_options</span>
        <span class="p">)</span>

        <span class="c1"># Add the classification prompt to the system prompt</span>
        <span class="n">effective_system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_system_prompts</span><span class="p">(</span>
            <span class="n">formatted_prompt</span><span class="p">,</span> <span class="n">system_prompt</span>
        <span class="p">)</span>

        <span class="c1"># Create a processing function that will validate and parse the response</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">process_classification_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_classification_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">max_options</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LLMMistake</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">error_type</span><span class="o">=</span><span class="s2">&quot;classification_format&quot;</span><span class="p">,</span>
                    <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LLM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="s2">&quot;max_options&quot;</span><span class="p">:</span> <span class="n">max_options</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="c1"># Generate classification using the retry mechanism</span>
        <span class="c1"># The result_processing_function returns List[str]</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="n">event_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;classify_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">effective_system_prompt</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># Classifications should be short</span>
            <span class="n">temp</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Use deterministic output for classifications</span>
            <span class="n">result_processing_function</span><span class="o">=</span><span class="n">process_classification_response</span><span class="p">,</span>
            <span class="n">retry_limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Use default retry limit</span>
        <span class="p">)</span>

        <span class="c1"># result is already List[str] due to the result_processing_function</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">usage</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_format_classification_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">categories</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">examples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_options</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the classification prompt with categories and examples.&quot;&quot;&quot;</span>
        <span class="c1"># Build category list</span>
        <span class="n">category_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># Build examples text if provided</span>
        <span class="n">examples_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">examples</span><span class="p">:</span>
            <span class="n">examples_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Examples:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;user_input&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Reasoning: </span><span class="si">{</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;doc_str&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Selection: </span><span class="si">{</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">examples</span>
            <span class="p">)</span>

        <span class="c1"># Build the prompt</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are a classification assistant. Your task is to classify the input into </span><span class="si">{</span><span class="s1">&#39;one category&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">max_options</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;up to </span><span class="si">{</span><span class="n">max_options</span><span class="si">}</span><span class="s1"> categories&#39;</span><span class="si">}</span><span class="s2"> from the following list:</span>

<span class="si">{</span><span class="n">category_text</span><span class="si">}</span>

<span class="si">{</span><span class="n">examples_text</span><span class="si">}</span>

<span class="s2">Rules:</span>
<span class="s2">1. Output ONLY the category number(s) in XML tags</span>
<span class="s2">2. For single selection use: &lt;choice&gt;N&lt;/choice&gt; where N is the category number</span>
<span class="s2">3. For multiple selections use: &lt;choices&gt;N,M&lt;/choices&gt; where N,M are category numbers</span>
<span class="s2">4. Numbers must be between 1 and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span><span class="si">}</span>
<span class="s2">5. Select at most </span><span class="si">{</span><span class="n">max_options</span><span class="si">}</span><span class="s2"> categories</span>
<span class="s2">6. Do not include any other text in your response</span>
<span class="s2">7. Do not explain your choice or add any additional formatting</span>

<span class="s2">Example outputs:</span>
<span class="s2">Single category: &lt;choice&gt;1&lt;/choice&gt;</span>
<span class="s2">Multiple categories: &lt;choices&gt;1,3&lt;/choices&gt;</span>

<span class="s2">Analyze the input and select the most appropriate </span><span class="si">{</span><span class="s1">&#39;category&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">max_options</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;categories&#39;</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_classification_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_options</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the model&#39;s response into a list of category names.&quot;&quot;&quot;</span>
        <span class="c1"># Try both patterns, ignoring everything outside the tags</span>
        <span class="n">single_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;choice&gt;(\d+)&lt;/choice&gt;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="n">multi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;choices&gt;([0-9,]+)&lt;/choices&gt;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">single_match</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">multi_match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not find valid choice tags in response&quot;</span><span class="p">)</span>

        <span class="c1"># Convert numbers to category names</span>
        <span class="k">if</span> <span class="n">single_match</span> <span class="ow">and</span> <span class="n">single_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">single_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">multi_match</span> <span class="ow">and</span> <span class="n">multi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">multi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid choice format in response&quot;</span><span class="p">)</span>

        <span class="c1"># Validate number of selections</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too many categories selected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">max_options</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate numbers</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid category numbers in response: </span><span class="si">{</span><span class="n">numbers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get category names</span>
        <span class="n">category_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">category_names</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_system_prompts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">classification_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine classification prompt with user&#39;s system prompt.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_prompt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">classification_prompt</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">classification_prompt</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="LLM.classify_from_file">
<a class="viewcode-back" href="../../../api.html#lluminary.models.base.LLM.classify_from_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">classify_from_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify messages using configuration from a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            config_path: Path to classification config JSON file</span>
<span class="sd">            messages: Messages to classify</span>
<span class="sd">            system_prompt: Optional system prompt override</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (selected categories, usage statistics)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load and validate config</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ClassificationConfig</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Perform classification</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span>
            <span class="n">examples</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">examples</span><span class="p">,</span>
            <span class="n">max_options</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_options</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, PimpMyNines.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>